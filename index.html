<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Malla Curricular Interactiva</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f9fd;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #0078d7;
    }
    .color-picker {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .color-picker label {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #niveles {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .nivel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 10px;
      width: 220px;
    }
    .nivel h2 {
      text-align: center;
      font-size: 16px;
      margin-bottom: 10px;
      background: #0078d7;
      color: white;
      padding: 5px 0;
      border-radius: 4px;
    }
    .ramo {
      margin: 5px 0;
      padding: 6px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      text-align: center;
      position: relative;
    }
    .ramo::after {
      content: attr(data-nota);
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 11px;
      color: #fff;
    }
    .resumen, .acciones {
      text-align: center;
      margin-top: 20px;
    }
    .resumen p {
      font-size: 15px;
      margin: 5px;
    }
    .resumen strong {
      font-size: 16px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, 0);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 10;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .modal input {
      width: 100%;
      margin: 5px 0;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 5;
    }
    button {
      padding: 8px 12px;
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Malla Curricular Interactiva</h1>

  <div class="color-picker">
    <label>Aprobado <input type="color" id="color-aprobado"></label>
    <label>Reprobado <input type="color" id="color-reprobado"></label>
    <label>Cursando <input type="color" id="color-cursando"></label>
    <label>No cursado <input type="color" id="color-nocursado"></label>
  </div>

  <div id="niveles"></div>

  <div class="resumen">
    <p>Aprobados: <span id="aprobados">0</span></p>
    <p>Reprobados: <span id="reprobados">0</span></p>
    <p>Cursando: <span id="cursando">0</span></p>
    <p>No cursado: <span id="nocursado">0</span></p>
    <p><strong>Avance total:</strong> <span id="avance">0%</span></p>
    <p><strong>Promedio general:</strong> <span id="promedioGeneral">0</span></p>
  </div>

  <div class="acciones">
    <button onclick="exportarPDF()">Exportar PDF</button>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="modal" id="modal">
    <h3>Notas del Ramo</h3>
    <div id="inputsNotas"></div>
    <button onclick="agregarInputNota()">+ Agregar Nota</button>
    <button onclick="guardarNotas()">Guardar</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const estados = ["aprobado", "reprobado", "cursando", "nocursado"];
    let ramoActual = null;

    const malla = [
      { nivel: 1, ramos: ["Morfología I", "Ciencias Biológicas y Químicas", "Módulo Gestión en Salud I", "Rol de la Matrona en la Sociedad"] },
      { nivel: 2, ramos: ["Fundamentos Biológicos II", "Morfología II", "Módulo Gestión en Salud II", "Electivo Cultural", "Atención de Salud Integral a la Mujer"] },
      { nivel: 3, ramos: ["Fundamentos Biológicos III", "Embriología y Genética", "Módulo Gestión en Salud III", "Puerperio y Salud Pública"] },
      { nivel: 4, ramos: ["Fundamentos Biológicos IV", "Módulo Gestión en Salud IV", "Electivo Cultural II", "Promoción de la Salud, Control Prenatal y Salud Pública"] },
      { nivel: 5, ramos: ["Atención Primaria y Ginecología Preventiva", "Módulo Gestión en Matronería I"] },
      { nivel: 6, ramos: ["Salud Sexual, Planificación Familiar", "Módulo Gestión en Matronería II"] },
      { nivel: 7, ramos: ["Obstetricia Preventiva I", "Módulo Gestión en Matronería III"] },
      { nivel: 8, ramos: ["Obstetricia Preventiva II", "Seminario Proyecto de Gestión o Investigación"] },
      { nivel: 9, ramos: ["Práctica Profesional Controlada I"] },
      { nivel: 10, ramos: ["Práctica Profesional Controlada II"] }
    ];

    function crearMalla() {
      const container = document.getElementById("niveles");
      malla.forEach(n => {
        const nivel = document.createElement("div");
        nivel.className = "nivel";
        nivel.innerHTML = `<h2>Nivel ${n.nivel}</h2>`;
        n.ramos.forEach(r => {
          const ramo = document.createElement("div");
          ramo.className = "ramo";
          ramo.textContent = r;
          ramo.dataset.nombre = `nivel${n.nivel}-${r}`;
          ramo.onclick = cambiarEstado;
          ramo.ondblclick = abrirModal;
          nivel.appendChild(ramo);
        });
        container.appendChild(nivel);
      });
    }

    function cambiarEstado(e) {
      const div = e.target;
      const nombre = div.dataset.nombre;
      let estadoActual = localStorage.getItem(nombre) || "nocursado";
      let index = estados.indexOf(estadoActual);
      let nuevoEstado = estados[(index + 1) % estados.length];
      div.className = "ramo " + nuevoEstado;
      localStorage.setItem(nombre, nuevoEstado);
      actualizarResumen();
      aplicarColores();
    }

    function cargarEstados() {
      document.querySelectorAll(".ramo").forEach(div => {
        let estado = localStorage.getItem(div.dataset.nombre) || "nocursado";
        div.classList.add(estado);
        let nota = JSON.parse(localStorage.getItem("notas_" + div.dataset.nombre));
        if (nota) {
          div.setAttribute("data-nota", nota.promedio.toFixed(1));
        }
      });
    }

    function actualizarResumen() {
      let contadores = { aprobado: 0, reprobado: 0, cursando: 0, nocursado: 0 };
      document.querySelectorAll(".ramo").forEach(r => {
        estados.forEach(est => {
          if (r.classList.contains(est)) contadores[est]++;
        });
      });
      let total = Object.values(contadores).reduce((a, b) => a + b, 0);
      document.getElementById("aprobados").textContent = contadores.aprobado;
      document.getElementById("reprobados").textContent = contadores.reprobado;
      document.getElementById("cursando").textContent = contadores.cursando;
      document.getElementById("nocursado").textContent = contadores.nocursado;
      let porcentaje = ((contadores.aprobado / total) * 100).toFixed(1);
      document.getElementById("avance").textContent = isNaN(porcentaje) ? "0%" : porcentaje + "%";

      // promedio general
      let totalNotas = 0;
      let sumaNotas = 0;
      document.querySelectorAll(".ramo").forEach(r => {
        const datos = JSON.parse(localStorage.getItem("notas_" + r.dataset.nombre));
        if (datos) {
          sumaNotas += datos.promedio;
          totalNotas++;
        }
      });
      document.getElementById("promedioGeneral").textContent = totalNotas ? (sumaNotas / totalNotas).toFixed(1) : "0";
    }

    function aplicarColores() {
      estados.forEach(estado => {
        const color = document.getElementById("color-" + estado).value;
        localStorage.setItem("color-" + estado, color);
        document.querySelectorAll("." + estado).forEach(elem => {
          elem.style.background = color;
        });
      });
    }

    function cargarColores() {
      estados.forEach(estado => {
        const picker = document.getElementById("color-" + estado);
        picker.value = localStorage.getItem("color-" + estado) || {
          aprobado: "#1abc9c", reprobado: "#e74c3c", cursando: "#3498db", nocursado: "#bdc3c7"
        }[estado];
        picker.oninput = aplicarColores;
      });
      aplicarColores();
    }

    function abrirModal(e) {
      ramoActual = e.target;
      const overlay = document.getElementById("overlay");
      const modal = document.getElementById("modal");
      const contenedor = document.getElementById("inputsNotas");
      contenedor.innerHTML = "";
      let datos = JSON.parse(localStorage.getItem("notas_" + ramoActual.dataset.nombre)) || { notas: [], promedio: 0 };
      datos.notas.forEach(nota => {
        const div = document.createElement("div");
        div.innerHTML = `<input type="number" placeholder="Nota" value="${nota.nota}"> <input type="number" placeholder="%" value="${nota.porcentaje}">`;
        contenedor.appendChild(div);
      });
      overlay.style.display = "block";
      modal.style.display = "block";
    }

    function agregarInputNota() {
      const div = document.createElement("div");
      div.innerHTML = `<input type="number" placeholder="Nota"> <input type="number" placeholder="%" >`;
      document.getElementById("inputsNotas").appendChild(div);
    }

    function guardarNotas() {
      const inputs = document.getElementById("inputsNotas").querySelectorAll("div");
      let total = 0;
      let suma = 0;
      let notas = [];
      inputs.forEach(div => {
        const nota = parseFloat(div.children[0].value);
        const porcentaje = parseFloat(div.children[1].value);
        if (!isNaN(nota) && !isNaN(porcentaje)) {
          suma += nota * (porcentaje / 100);
          total += porcentaje;
          notas.push({ nota, porcentaje });
        }
      });
      let promedio = total ? suma : 0;
      localStorage.setItem("notas_" + ramoActual.dataset.nombre, JSON.stringify({ notas, promedio }));
      ramoActual.setAttribute("data-nota", promedio.toFixed(1));
      cerrarModal();
      actualizarResumen();
    }

    function cerrarModal() {
      document.getElementById("modal").style.display = "none";
      document.getElementById("overlay").style.display = "none";
    }

    async function exportarPDF() {
      const canvas = await html2canvas(document.body);
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jspdf.jsPDF("p", "mm", "a4");
      const width = pdf.internal.pageSize.getWidth();
      const height = (canvas.height * width) / canvas.width;
      pdf.addImage(imgData, "PNG", 0, 0, width, height);
      pdf.save("malla_curricular.pdf");
    }

    window.onload = () => {
      crearMalla();
      cargarEstados();
      actualizarResumen();
      cargarColores();
    };
  </script>
</body>
</html>
