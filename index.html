<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Malla Curricular de Dafne</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f9fd;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #0078d7;
      user-select: none;
      cursor: pointer;
    }
    .color-picker {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    .color-picker label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      user-select: none;
    }
    #niveles {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .nivel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 10px;
      width: 220px;
      transition: background 0.3s ease;
      cursor: pointer;
      user-select: none;
    }
    .nivel h2 {
      text-align: center;
      font-size: 16px;
      margin-bottom: 10px;
      background: #0078d7;
      color: white;
      padding: 5px 0;
      border-radius: 4px;
      user-select: none;
      cursor: pointer; /* Indicar que se puede clicear */
    }
    .ramo {
      margin: 5px 0;
      padding: 6px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      text-align: center;
      position: relative;
      user-select: none;
    }

    .resumen, .acciones {
      text-align: center;
      margin-top: 20px;
    }
    .resumen p {
      font-size: 15px;
      margin: 5px;
    }
    .resumen strong {
      font-size: 16px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, 0);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 10;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      max-width: 300px;
      width: 90%;
    }
    .modal input[type="number"] {
      width: 48%;
      margin: 5px 1%;
      box-sizing: border-box;
      padding: 6px;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 5;
    }
    button {
      padding: 8px 12px;
      margin: 10px 5px 5px 5px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1 id="titulo-principal" title="Doble clic para cambiar color">Malla Curricular de Dafne ‚Äî Para que sea la mejor matrona del mundo üë∂üèºüíñ</h1>

  <div class="color-picker">
    <label>Aprobado <input type="color" id="color-aprobado"></label>
    <label>Reprobado <input type="color" id="color-reprobado"></label>
    <label>Cursando <input type="color" id="color-cursando"></label>
    <label>No cursado <input type="color" id="color-nocursado"></label>
  </div>

  <div id="niveles"></div>

  <div class="resumen">
    <p>Aprobados: <span id="aprobados">0</span></p>
    <p>Reprobados: <span id="reprobados">0</span></p>
    <p>Cursando: <span id="cursando">0</span></p>
    <p>No cursado: <span id="nocursado">0</span></p>
    <p><strong>Avance total:</strong> <span id="avance">0%</span></p>
    <p><strong>Promedio general:</strong> <span id="promedioGeneral">0</span></p>
  </div>

  <div class="acciones">
    <button onclick="exportarPDF()">Exportar PDF</button>
    <button onclick="resetearMalla()">Resetear malla</button>
  </div>

  <div class="overlay" id="overlay" onclick="cerrarModal()"></div>
  <div class="modal" id="modal">
    <h3>Notas del Ramo</h3>
    <div id="inputsNotas"></div>
    <button onclick="agregarInputNota()">+ Agregar Nota</button>
    <button onclick="guardarNotas()">Guardar</button>
    <button onclick="eliminarNotas()">üóëÔ∏è Eliminar notas</button>
  </div>

  <!-- Inputs ocultos para selectores de color -->
  <input type="color" id="color-fondo-niveles" style="display:none;">
  <input type="color" id="bgColorPicker" style="display:none;">
  <input type="color" id="color-titulo" style="display:none;">
  <input type="color" id="color-semestre" style="display:none;">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const estados = ["aprobado", "reprobado", "cursando", "nocursado"];
    let ramoActual = null;

    const malla = [
      { nivel: 1, ramos: ["Morfolog√≠a I", "Ciencias Biol√≥gicas y Qu√≠micas", "M√≥dulo Gesti√≥n en Salud I", "Rol de la Matrona en la Sociedad"] },
      { nivel: 2, ramos: ["Fundamentos Biol√≥gicos I", "Morfolog√≠a II", "M√≥dulo Gesti√≥n en Salud II", "Electivo Cultural", "Atenci√≥n de Salud Integral a la Mujer"] },
      { nivel: 3, ramos: ["Fundamentos Biol√≥gicos II", "Embriolog√≠a y Gen√©tica", "M√≥dulo Gesti√≥n en Salud III", "Puerperio y Salud P√∫blica"] },
      { nivel: 4, ramos: ["Fundamentos Biol√≥gicos III", "M√≥dulo Gesti√≥n en Salud IV", "Electivo Cultural II", "Promoci√≥n de la Salud, Control Prenatal y Salud P√∫blica"] },
      { nivel: 5, ramos: ["Atenci√≥n Primaria y Ginecolog√≠a Preventiva", "M√≥dulo Gesti√≥n en Matroner√≠a I"] },
      { nivel: 6, ramos: ["Salud Sexual, Planificaci√≥n Familiar", "M√≥dulo Gesti√≥n en Matroner√≠a II"] },
      { nivel: 7, ramos: ["Obstetricia Preventiva I", "M√≥dulo Gesti√≥n en Matroner√≠a III"] },
      { nivel: 8, ramos: ["Obstetricia Preventiva II", "Seminario Proyecto de Gesti√≥n o Investigaci√≥n"] },
      { nivel: 9, ramos: ["Pr√°ctica Profesional Controlada I"] },
      { nivel: 10, ramos: ["Pr√°ctica Profesional Controlada II"] }
    ];

    function crearMalla() {
      const container = document.getElementById("niveles");
      container.innerHTML = "";
      malla.forEach(n => {
        const nivel = document.createElement("div");
        nivel.className = "nivel";
        nivel.dataset.nivel = n.nivel;
        nivel.innerHTML = `<h2 data-nivel="${n.nivel}">Semestre ${n.nivel}</h2>`;
        n.ramos.forEach(r => {
          const ramo = document.createElement("div");
          ramo.className = "ramo";
          ramo.textContent = r;
          ramo.dataset.nombre = `nivel${n.nivel}-${r}`;
          agregarEventosRamo(ramo);
          nivel.appendChild(ramo);
        });
        container.appendChild(nivel);
      });

      // Aplicar color de fondo niveles guardado o blanco
      const colorGuardado = localStorage.getItem("color-fondo-niveles") || "#ffffff";
      aplicarColorFondoNiveles(colorGuardado);

      // Aplicar colores guardados para "Semestre" (fondo azul)
      aplicarColorSemestre(localStorage.getItem("color-semestre") || "#0078d7");

      // Aplicar color t√≠tulo y sincronizar color texto "Semestre X"
      const colorTituloGuardado = localStorage.getItem("color-titulo") || "#0078d7";
      const titulo = document.getElementById("titulo-principal");
      titulo.style.color = colorTituloGuardado;
      document.querySelectorAll(".nivel h2").forEach(h2 => {
        h2.style.color = colorTituloGuardado;
      });

      // Doble clic para cambiar color fondo niveles (en fondo nivel, no ramos ni h2)
      document.querySelectorAll(".nivel").forEach(nivelDiv => {
        nivelDiv.addEventListener("dblclick", (e) => {
          if (e.target.classList.contains("ramo") || e.target.tagName === "H2") return; // Ignorar si clic en ramo o h2
          const colorPicker = document.getElementById("color-fondo-niveles");
          colorPicker.value = localStorage.getItem("color-fondo-niveles") || "#ffffff";
          colorPicker.click();
        });
      });

      // Doble clic en t√≠tulo principal para cambiar color (texto t√≠tulo y "Semestre X")
      titulo.addEventListener("dblclick", () => {
        const colorTituloPicker = document.getElementById("color-titulo");
        colorTituloPicker.value = localStorage.getItem("color-titulo") || "#0078d7";
        colorTituloPicker.click();
      });

      // Doble clic en "Semestre X" para cambiar solo el fondo azul (del recuadro)
      document.querySelectorAll(".nivel h2").forEach(h2 => {
        h2.addEventListener("dblclick", () => {
          const colorSemestrePicker = document.getElementById("color-semestre");
          colorSemestrePicker.value = localStorage.getItem("color-semestre") || "#0078d7";
          colorSemestrePicker.click();
        });
      });
    }

    function agregarEventosRamo(ramo) {
      ramo.onclick = cambiarEstado;

      // Tap largo para m√≥vil abre modal
      let timer = null;
      ramo.addEventListener('touchstart', e => {
        timer = setTimeout(() => {
          abrirModal({target: ramo});
        }, 700);
      });
      ramo.addEventListener('touchend', e => {
        if (timer) {
          clearTimeout(timer);
          timer = null;
        }
      });
      ramo.addEventListener('touchmove', e => {
        if (timer) {
          clearTimeout(timer);
          timer = null;
        }
      });

      // Doble clic abre modal notas (solo)
      ramo.ondblclick = abrirModal;
    }

    function cambiarEstado(e) {
      const div = e.target;
      const nombre = div.dataset.nombre;
      let estadoActual = localStorage.getItem(nombre) || "nocursado";
      let index = estados.indexOf(estadoActual);
      let nuevoEstado = estados[(index + 1) % estados.length];
      div.className = "ramo " + nuevoEstado;
      localStorage.setItem(nombre, nuevoEstado);
      actualizarResumen();
      aplicarColores();
    }

    function cargarEstados() {
      document.querySelectorAll(".ramo").forEach(div => {
        let estado = localStorage.getItem(div.dataset.nombre) || "nocursado";
        div.classList.add(estado);
      });
    }

    function actualizarResumen() {
      let contadores = { aprobado: 0, reprobado: 0, cursando: 0, nocursado: 0 };
      document.querySelectorAll(".ramo").forEach(r => {
        estados.forEach(est => {
          if (r.classList.contains(est)) contadores[est]++;
        });
      });
      let total = Object.values(contadores).reduce((a, b) => a + b, 0);
      document.getElementById("aprobados").textContent = contadores.aprobado;
      document.getElementById("reprobados").textContent = contadores.reprobado;
      document.getElementById("cursando").textContent = contadores.cursando;
      document.getElementById("nocursado").textContent = contadores.nocursado;
      let porcentaje = ((contadores.aprobado / total) * 100).toFixed(1);
      document.getElementById("avance").textContent = isNaN(porcentaje) ? "0%" : porcentaje + "%";

      // promedio general
      let totalNotas = 0;
      let sumaNotas = 0;
      document.querySelectorAll(".ramo").forEach(r => {
        const datos = JSON.parse(localStorage.getItem("notas_" + r.dataset.nombre));
        if (datos) {
          sumaNotas += datos.promedio;
          totalNotas++;
        }
      });
      document.getElementById("promedioGeneral").textContent = totalNotas ? (sumaNotas / totalNotas).toFixed(1) : "0";
    }

    function aplicarColores() {
      estados.forEach(estado => {
        const color = document.getElementById("color-" + estado).value;
        localStorage.setItem("color-" + estado, color);
        document.querySelectorAll("." + estado).forEach(elem => {
          elem.style.background = color;
        });
      });
    }

    function cargarColores() {
      estados.forEach(estado => {
        const picker = document.getElementById("color-" + estado);
        picker.value = localStorage.getItem("color-" + estado) || {
          aprobado: "#1abc9c", reprobado: "#e74c3c", cursando: "#3498db", nocursado: "#bdc3c7"
        }[estado];
        picker.oninput = aplicarColores;
      });
      aplicarColores();

      // Cargar y aplicar color titulo guardado
      const colorTitulo = localStorage.getItem("color-titulo") || "#0078d7";
      const tituloElem = document.getElementById("titulo-principal");
      tituloElem.style.color = colorTitulo;
      // Sincronizar color de los t√≠tulos semestre tambi√©n
      document.querySelectorAll(".nivel h2").forEach(h2 => {
        h2.style.color = colorTitulo;
      });

      // Cambiar color titulo al elegir en input oculto
      const tituloColorInput = document.getElementById("color-titulo");
      tituloColorInput.addEventListener("input", (e) => {
        const color = e.target.value;
        tituloElem.style.color = color;
        // Sincronizar color de los t√≠tulos semestre tambi√©n
        document.querySelectorAll(".nivel h2").forEach(h2 => {
          h2.style.color = color;
        });
        localStorage.setItem("color-titulo", color);
      });

      // Cambiar color "Semestre" al elegir en input oculto (solo fondo azul)
      const semestreColorInput = document.getElementById("color-semestre");
      semestreColorInput.addEventListener("input", (e) => {
        const color = e.target.value;
        aplicarColorSemestre(color);
        localStorage.setItem("color-semestre", color);
      });
    }

    // Cambiar color fondo niveles cuando cambia input oculto
    const colorFondoNiveles = document.getElementById("color-fondo-niveles");
    colorFondoNiveles.addEventListener("input", (e) => {
      const color = e.target.value;
      localStorage.setItem("color-fondo-niveles", color);
      aplicarColorFondoNiveles(color);
    });

    function aplicarColorFondoNiveles(color) {
      document.querySelectorAll(".nivel").forEach(nivelDiv => {
        nivelDiv.style.background = color;
      });
    }

    function aplicarColorSemestre(color) {
      document.querySelectorAll(".nivel h2").forEach(h2 => {
        h2.style.background = color;
      });
    }

    function abrirModal(e) {
      ramoActual = e.target;
      const overlay = document.getElementById("overlay");
      const modal = document.getElementById("modal");
      const contenedor = document.getElementById("inputsNotas");
      contenedor.innerHTML = "";
      let datos = JSON.parse(localStorage.getItem("notas_" + ramoActual.dataset.nombre)) || { notas: [], promedio: 0 };
      datos.notas.forEach(nota => {
        const div = document.createElement("div");
        div.innerHTML = `<input type="number" placeholder="Nota" value="${nota.nota}" min="0" max="100" step="0.1"> <input type="number" placeholder="%" value="${nota.porcentaje}" min="0" max="100" step="0.1">`;
        contenedor.appendChild(div);
      });
      overlay.style.display = "block";
      modal.style.display = "block";
    }

    function agregarInputNota() {
      const div = document.createElement("div");
      div.innerHTML = `<input type="number" placeholder="Nota" min="0" max="100" step="0.1"> <input type="number" placeholder="%" min="0" max="100" step="0.1">`;
      document.getElementById("inputsNotas").appendChild(div);
    }

    function guardarNotas() {
      const inputs = document.querySelectorAll("#inputsNotas div");
      let notas = [];
      let sumaPorcentaje = 0;
      let sumaPonderada = 0;
      for (let div of inputs) {
        let notaInput = div.children[0];
        let porcentajeInput = div.children[1];
        let nota = parseFloat(notaInput.value);
        let porcentaje = parseFloat(porcentajeInput.value);
        if (isNaN(nota) || isNaN(porcentaje) || porcentaje <= 0) continue;
        notas.push({ nota, porcentaje });
        sumaPorcentaje += porcentaje;
        sumaPonderada += nota * porcentaje;
      }
      let promedio = sumaPorcentaje ? sumaPonderada / sumaPorcentaje : 0;
      localStorage.setItem("notas_" + ramoActual.dataset.nombre, JSON.stringify({ notas, promedio }));
      cerrarModal();
      actualizarResumen();
    }

    function eliminarNotas() {
      localStorage.removeItem("notas_" + ramoActual.dataset.nombre);
      cerrarModal();
      actualizarResumen();
    }

    function cerrarModal() {
      document.getElementById("overlay").style.display = "none";
      document.getElementById("modal").style.display = "none";
      ramoActual = null;
    }

    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const titulo = document.getElementById("titulo-principal").textContent;
      doc.setFontSize(16);
      doc.text(titulo, 10, 10);
      let y = 20;

      malla.forEach(n => {
        doc.setFontSize(14);
        doc.text(`Semestre ${n.nivel}`, 10, y);
        y += 7;
        n.ramos.forEach(r => {
          let estado = localStorage.getItem(`nivel${n.nivel}-${r}`) || "nocursado";
          let texto = `${r} [${estado}]`;
          doc.setFontSize(12);
          doc.text(texto, 12, y);
          y += 6;
          if (y > 280) {
            doc.addPage();
            y = 10;
          }
        });
        y += 5;
      });

      doc.save("malla-curricular.pdf");
    }

    function resetearMalla() {
      if (!confirm("¬øQuieres resetear toda la malla y notas?")) return;
      localStorage.clear();
      location.reload();
    }

    // Doble clic en fondo body para cambiar color fondo general p√°gina
    document.body.addEventListener("dblclick", (e) => {
      // Solo si doble clic fuera de zonas clickeables (niveles, titulo, etc)
      if (e.target === document.body) {
        const bgPicker = document.getElementById("bgColorPicker");
        bgPicker.value = window.getComputedStyle(document.body).backgroundColor;
        bgPicker.click();
      }
    });

    const bgColorPicker = document.getElementById("bgColorPicker");
    bgColorPicker.addEventListener("input", e => {
      document.body.style.backgroundColor = e.target.value;
      localStorage.setItem("color-fondo-general", e.target.value);
    });

    // Aplicar color fondo general guardado
    function aplicarFondoGeneral() {
      const color = localStorage.getItem("color-fondo-general") || "#f5f9fd";
      document.body.style.backgroundColor = color;
    }

    window.onload = () => {
      crearMalla();
      cargarEstados();
      cargarColores();
      actualizarResumen();
      aplicarFondoGeneral();
    };
  </script>
</body>
</html>
